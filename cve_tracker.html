<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>לוח מעקב CVE אינטראקטיבי</title>
    <!-- ייבוא ספריית Chart.js לגרפים -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent: #3b82f6;
            --critical: #ef4444;
            --high: #f97316;
            --medium: #eab308;
            --low: #22c55e;
            --border: #334155;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 20px;
        }

        h1 { margin: 0; font-size: 1.8rem; }
        .subtitle { color: var(--text-secondary); font-size: 0.9rem; margin-top: 5px; }

        /* Status Bar */
        .status-bar {
            font-size: 0.85rem;
            padding: 5px 10px;
            border-radius: 4px;
            background: var(--card-bg);
        }
        .status-loading { color: var(--accent); }
        .status-error { color: var(--critical); }
        .status-success { color: var(--low); }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        /* Stats Cards */
        .stat-card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .stat-value { font-size: 2.5rem; font-weight: bold; display: block; margin-bottom: 5px; }
        .stat-label { color: var(--text-secondary); font-size: 0.9rem; }
        .stat-critical { color: var(--critical); }
        .stat-high { color: var(--high); }
        .stat-total { color: var(--text-primary); }

        /* Charts Section */
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .chart-wrapper {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            height: 300px;
            position: relative;
        }

        /* Filters & Search */
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        input, select {
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 10px;
            border-radius: 6px;
            outline: none;
        }
        input:focus, select:focus { border-color: var(--accent); }
        .search-box { flex-grow: 1; }

        /* CVE List Table */
        .cve-list-container {
            background-color: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            text-align: right;
        }
        th, td {
            padding: 15px;
            border-bottom: 1px solid var(--border);
        }
        th {
            background-color: rgba(255,255,255,0.05);
            color: var(--text-secondary);
            font-weight: 600;
        }
        tr:hover { background-color: rgba(255,255,255,0.02); }
        
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            display: inline-block;
            min-width: 60px;
            text-align: center;
        }
        .bg-critical { background: rgba(239, 68, 68, 0.2); color: var(--critical); border: 1px solid rgba(239, 68, 68, 0.3); }
        .bg-high { background: rgba(249, 115, 22, 0.2); color: var(--high); border: 1px solid rgba(249, 115, 22, 0.3); }
        .bg-medium { background: rgba(234, 179, 8, 0.2); color: var(--medium); border: 1px solid rgba(234, 179, 8, 0.3); }
        .bg-low { background: rgba(34, 197, 94, 0.2); color: var(--low); border: 1px solid rgba(34, 197, 94, 0.3); }
        .bg-unknown { background: rgba(148, 163, 184, 0.2); color: var(--text-secondary); }

        .cve-id { font-family: monospace; color: var(--accent); font-weight: bold; }
        .expand-btn {
            background: none;
            border: none;
            color: var(--accent);
            cursor: pointer;
            font-size: 0.9rem;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .dashboard-grid { grid-template-columns: repeat(2, 1fr); }
            .charts-container { grid-template-columns: 1fr; }
        }
        @media (max-width: 600px) {
            .dashboard-grid { grid-template-columns: 1fr; }
            .controls { flex-direction: column; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1>לוח מעקב פגיעויות (CVE Tracker)</h1>
            <div class="subtitle">מציג נתונים מה-30 ימים האחרונים (מקור: NVD NIST)</div>
        </div>
        <div id="apiStatus" class="status-bar status-loading">טוען נתונים...</div>
    </header>

    <!-- KPI Cards -->
    <div class="dashboard-grid">
        <div class="stat-card">
            <span class="stat-value stat-total" id="totalCount">0</span>
            <span class="stat-label">סה"כ פגיעויות</span>
        </div>
        <div class="stat-card">
            <span class="stat-value stat-critical" id="criticalCount">0</span>
            <span class="stat-label">קריטיות (Critical)</span>
        </div>
        <div class="stat-card">
            <span class="stat-value stat-high" id="highCount">0</span>
            <span class="stat-label">גבוהות (High)</span>
        </div>
        <div class="stat-card">
            <span class="stat-value" id="avgScore" style="color: var(--accent)">0.0</span>
            <span class="stat-label">ציון CVSS ממוצע</span>
        </div>
    </div>

    <!-- Charts -->
    <div class="charts-container">
        <div class="chart-wrapper">
            <canvas id="severityChart"></canvas>
        </div>
        <div class="chart-wrapper">
            <canvas id="trendChart"></canvas>
        </div>
    </div>

    <!-- Filters & List -->
    <div class="controls">
        <input type="text" id="searchInput" class="search-box" placeholder="חפש לפי מזהה CVE, מוצר או תיאור...">
        <select id="severityFilter">
            <option value="all">כל הרמות</option>
            <option value="CRITICAL">קריטי</option>
            <option value="HIGH">גבוה</option>
            <option value="MEDIUM">בינוני</option>
            <option value="LOW">נמוך</option>
        </select>
    </div>

    <div class="cve-list-container">
        <table>
            <thead>
                <tr>
                    <th>מזהה CVE</th>
                    <th>ציון (CVSS)</th>
                    <th>חומרה</th>
                    <th>מוצר / יצרן</th>
                    <th>תאריך פרסום</th>
                    <th>תיאור קצר</th>
                    <th>פעולות</th>
                </tr>
            </thead>
            <tbody id="cveTableBody">
                <!-- Rows will be populated by JS -->
            </tbody>
        </table>
    </div>
</div>

<script>
    // State Management
    let cveData = [];
    let charts = {};

    // --- Configuration ---
    // NVD API Endpoint (Last 30 days logic)
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(endDate.getDate() - 30);
    
    // Formatting dates for API (ISO 8601)
    const formatDateStart = (d) => d.toISOString().split('T')[0] + 'T00:00:00.000';
    const formatDateEnd = (d) => d.toISOString().split('T')[0] + 'T23:59:59.999';

    // Helper to extract Product/Vendor from CPE
    function getProduct(item) {
        if (!item.cve.configurations || item.cve.configurations.length === 0) return "לא צוין";
        
        try {
            // Traverse configurations -> nodes -> cpeMatch -> criteria
            // Format: cpe:2.3:a:vendor:product:version...
            for (const config of item.cve.configurations) {
                for (const node of config.nodes) {
                    if (node.cpeMatch) {
                        for (const match of node.cpeMatch) {
                            if (match.criteria) {
                                const parts = match.criteria.split(':');
                                if (parts.length >= 5) {
                                    // parts[3] is vendor, parts[4] is product
                                    return `${parts[3]} ${parts[4]}`.replace(/_/g, ' ');
                                }
                            }
                        }
                    }
                }
            }
        } catch (e) {
            return "שגיאה בפענוח";
        }
        return "כללי / לא צוין";
    }
    
    // Fallback Mock Data (in case API fails or hits rate limit)
    const mockData = [
        { cve: { id: "CVE-2024-DEMO-01", published: new Date().toISOString(), descriptions: [{ value: "פגיעות הזרקת SQL במערכת הדגמה." }], metrics: { cvssMetricV31: [{ cvssData: { baseScore: 9.8, baseSeverity: "CRITICAL" } }] } } },
        { cve: { id: "CVE-2024-DEMO-02", published: new Date(Date.now() - 86400000).toISOString(), descriptions: [{ value: "חולשת XSS במסך התחברות." }], metrics: { cvssMetricV31: [{ cvssData: { baseScore: 6.1, baseSeverity: "MEDIUM" } }] } } },
        { cve: { id: "CVE-2024-DEMO-03", published: new Date(Date.now() - 172800000).toISOString(), descriptions: [{ value: "גלישת חוצץ ברכיב רשת." }], metrics: { cvssMetricV31: [{ cvssData: { baseScore: 7.5, baseSeverity: "HIGH" } }] } } },
        { cve: { id: "CVE-2024-DEMO-04", published: new Date(Date.now() - 250000000).toISOString(), descriptions: [{ value: "דליפת מידע רגיש." }], metrics: { cvssMetricV31: [{ cvssData: { baseScore: 5.3, baseSeverity: "MEDIUM" } }] } } },
        { cve: { id: "CVE-2024-DEMO-05", published: new Date(Date.now() - 50000000).toISOString(), descriptions: [{ value: "הרצת קוד מרחוק (RCE)." }], metrics: { cvssMetricV31: [{ cvssData: { baseScore: 9.0, baseSeverity: "CRITICAL" } }] } } },
    ];

    // --- Main Functions ---

    async function init() {
        document.getElementById('searchInput').addEventListener('input', renderTable);
        document.getElementById('severityFilter').addEventListener('change', renderTable);
        await fetchCVEs();
    }

    async function fetchCVEs() {
        const apiUrl = `https://services.nvd.nist.gov/rest/json/cves/2.0?pubStartDate=${formatDateStart(startDate)}&pubEndDate=${formatDateEnd(endDate)}&resultsPerPage=50`;
        const statusEl = document.getElementById('apiStatus');

        try {
            statusEl.textContent = "טוען נתונים מ-NVD API...";
            // Note: NVD API is slow and strictly rate-limited without a key. 
            // We use a timeout to failover to mock data if it hangs.
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 8000); // 8 sec timeout

            const response = await fetch(apiUrl, { signal: controller.signal });
            clearTimeout(timeoutId);

            if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
            
            const data = await response.json();
            cveData = data.vulnerabilities;
            statusEl.className = "status-bar status-success";
            statusEl.textContent = "הנתונים עודכנו בהצלחה (Live API)";
        } catch (error) {
            console.warn("API Fetch failed, using mock data:", error);
            cveData = mockData;
            statusEl.className = "status-bar status-error";
            statusEl.textContent = "שגיאת רשת/API - מציג נתוני הדגמה (Demo Mode)";
        }

        processAndRender();
    }

    function getSeverity(item) {
        // Try V3.1, then V3.0, then V2
        const metrics = item.cve.metrics;
        if (metrics?.cvssMetricV31) return metrics.cvssMetricV31[0].cvssData;
        if (metrics?.cvssMetricV30) return metrics.cvssMetricV30[0].cvssData;
        if (metrics?.cvssMetricV2) return { baseScore: metrics.cvssMetricV2[0].cvssData.baseScore, baseSeverity: metrics.cvssMetricV2[0].baseSeverity || "UNKNOWN" };
        return { baseScore: 0, baseSeverity: "UNKNOWN" };
    }

    function processAndRender() {
        // Sort Data: Newest First (Descending Order)
        cveData.sort((a, b) => new Date(b.cve.published) - new Date(a.cve.published));

        // Stats Calculation
        let stats = { total: 0, critical: 0, high: 0, medium: 0, low: 0, sumScore: 0 };
        const severityCounts = { CRITICAL: 0, HIGH: 0, MEDIUM: 0, LOW: 0, UNKNOWN: 0 };
        
        cveData.forEach(item => {
            const sev = getSeverity(item);
            stats.total++;
            stats.sumScore += sev.baseScore;
            
            let label = sev.baseSeverity ? sev.baseSeverity.toUpperCase() : "UNKNOWN";
            if(severityCounts[label] !== undefined) severityCounts[label]++;
            
            if (label === 'CRITICAL') stats.critical++;
            if (label === 'HIGH') stats.high++;
        });

        // Update DOM Stats
        document.getElementById('totalCount').innerText = stats.total;
        document.getElementById('criticalCount').innerText = stats.critical;
        document.getElementById('highCount').innerText = stats.high;
        document.getElementById('avgScore').innerText = stats.total ? (stats.sumScore / stats.total).toFixed(1) : "0";

        renderCharts(severityCounts);
        renderTable();
    }

    function renderCharts(counts) {
        // Severity Chart (Doughnut)
        const ctxSev = document.getElementById('severityChart').getContext('2d');
        if (charts.severity) charts.severity.destroy();

        charts.severity = new Chart(ctxSev, {
            type: 'doughnut',
            data: {
                labels: ['קריטי', 'גבוה', 'בינוני', 'נמוך', 'לא ידוע'],
                datasets: [{
                    data: [counts.CRITICAL, counts.HIGH, counts.MEDIUM, counts.LOW, counts.UNKNOWN],
                    backgroundColor: ['#ef4444', '#f97316', '#eab308', '#22c55e', '#94a3b8'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { color: '#fff' } },
                    title: { display: true, text: 'התפלגות לפי חומרה', color: '#fff' }
                }
            }
        });

        // Trend Chart (Line) - Group by Date
        const dateGroups = {};
        cveData.forEach(item => {
            const date = item.cve.published.split('T')[0];
            dateGroups[date] = (dateGroups[date] || 0) + 1;
        });
        
        // Sort dates
        const sortedDates = Object.keys(dateGroups).sort();
        const dataPoints = sortedDates.map(d => dateGroups[d]);

        const ctxTrend = document.getElementById('trendChart').getContext('2d');
        if (charts.trend) charts.trend.destroy();

        charts.trend = new Chart(ctxTrend, {
            type: 'line',
            data: {
                labels: sortedDates,
                datasets: [{
                    label: 'פגיעויות שפורסמו',
                    data: dataPoints,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.2)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { labels: { color: '#fff' } },
                    title: { display: true, text: 'מגמת פרסום (30 ימים אחרונים)', color: '#fff' }
                },
                scales: {
                    y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                    x: { grid: { display: false }, ticks: { color: '#94a3b8', maxTicksLimit: 5 } }
                }
            }
        });
    }

    function renderTable() {
        const tbody = document.getElementById('cveTableBody');
        tbody.innerHTML = '';
        
        const search = document.getElementById('searchInput').value.toLowerCase();
        const filter = document.getElementById('severityFilter').value;

        const filtered = cveData.filter(item => {
            const sev = getSeverity(item);
            const desc = item.cve.descriptions[0]?.value.toLowerCase() || "";
            const id = item.cve.id.toLowerCase();
            
            const matchesSearch = id.includes(search) || desc.includes(search);
            const matchesFilter = filter === 'all' || sev.baseSeverity === filter;

            return matchesSearch && matchesFilter;
        });

        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 20px;">לא נמצאו תוצאות</td></tr>';
            return;
        }

        filtered.slice(0, 50).forEach(item => { // Limit render for performance
            const sev = getSeverity(item);
            const tr = document.createElement('tr');
            
            // Badge Logic
            const sevClass = `bg-${sev.baseSeverity ? sev.baseSeverity.toLowerCase() : 'unknown'}`;
            const sevLabel = sev.baseSeverity || 'Unknown';
            const product = getProduct(item);

            tr.innerHTML = `
                <td><span class="cve-id">${item.cve.id}</span></td>
                <td>${sev.baseScore || 'N/A'}</td>
                <td><span class="badge ${sevClass}">${sevLabel}</span></td>
                <td style="font-size: 0.9em; color: var(--text-primary);">${product}</td>
                <td>${item.cve.published.split('T')[0]}</td>
                <td style="max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${item.cve.descriptions[0]?.value}">
                    ${item.cve.descriptions[0]?.value || 'No description'}
                </td>
                <td>
                    <button class="expand-btn" onclick="window.open('https://nvd.nist.gov/vuln/detail/${item.cve.id}', '_blank')">פרטים</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // Initialize
    init();

</script>

</body>
</html>

